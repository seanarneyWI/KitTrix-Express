// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

// üö® CRITICAL: SHARED DATABASE WARNING üö®
// This schema connects to motioPGDB which is a SHARED ERP database used by:
// - KitTrix-Express (this app)
// - Estimating-app (quoting system)
// - Other ERP systems
//
// TABLES NOT MANAGED BY THIS SCHEMA (DO NOT DROP):
// - board_adders, board_grades, estimates, flute_types, liner_materials
// - medium_types, metrics, migrations, motioevents, shipping_zones, vendors
// - customers_backup, and other ERP tables
//
// SHARED TABLES (Read-only for KitTrix):
// - companies: Used by multiple apps, KitTrix reads via foreign key only
//
// KITTRIX-OWNED TABLES (Safe to manage):
// - kitting_jobs, route_steps, job_progress, kit_executions, step_executions
// - job_analytics, users, work_centers, job_assignments
//
// ‚ö†Ô∏è NEVER USE: prisma db push (will try to drop existing tables!)
// ‚úÖ SAFE TO USE: prisma generate, prisma migrate dev (with caution)
// ‚úÖ FOR SCHEMA CHANGES: Write manual SQL migrations, coordinate with other apps

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model KittingJob {
  id              String   @id @default(cuid())
  customerName    String
  companyId       Int?
  company         Company? @relation(fields: [companyId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  jobNumber       String   @unique
  dueDate         DateTime
  orderedQuantity Int
  runLength       Int
  customerSpec    String?
  description     String
  setup           Int      // seconds
  makeReady       Int      // seconds
  takeDown        Int      // seconds

  // Calculated fields
  expectedKitDuration Int // EKD in seconds
  expectedJobDuration Int // EJD in seconds

  // Scheduling
  scheduledDate     DateTime?
  scheduledStartTime String?

  // Status tracking
  status        JobStatus @default(SCHEDULED)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  routeSteps    RouteStep[]
  jobProgress   JobProgress?
  analytics     JobAnalytics?
  assignments   JobAssignment[]

  @@map("kitting_jobs")
}

model RouteStep {
  id              String @id @default(cuid())
  name            String
  expectedSeconds Int
  order           Int    // For maintaining step sequence

  // Multimedia instruction fields
  instructionType InstructionType @default(NONE)
  instructionUrl  String?         // External URL for videos/images
  instructionText String?         // Text instructions
  autoLoop        Boolean         @default(true) // Auto-loop for videos

  // Relations
  kittingJobId    String
  kittingJob      KittingJob @relation(fields: [kittingJobId], references: [id], onDelete: Cascade)

  // Step executions during job runs
  stepExecutions  StepExecution[]

  @@map("route_steps")
}

model JobProgress {
  id              String    @id @default(cuid())
  jobId           String    @unique
  kittingJob      KittingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Job timing
  startTime       DateTime?
  endTime         DateTime?
  actualJobDuration Int?   // seconds

  // Kit tracking
  completedKits   Int       @default(0)
  remainingKits   Int
  currentKitNumber Int?

  // Status
  isActive        Boolean   @default(false)
  pausedTime      Int       @default(0) // accumulated pause time in seconds

  // Work center assignment
  workCenterId    String?
  workCenter      WorkCenter? @relation(fields: [workCenterId], references: [id])
  assignedWorker  String?

  // Relations
  kitExecutions   KitExecution[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("job_progress")
}

model KitExecution {
  id              String       @id @default(cuid())
  jobProgressId   String
  jobProgress     JobProgress  @relation(fields: [jobProgressId], references: [id], onDelete: Cascade)

  kitNumber       Int
  startTime       DateTime
  endTime         DateTime?
  actualDuration  Int?         // seconds
  completed       Boolean      @default(false)

  // Relations
  stepExecutions  StepExecution[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("kit_executions")
}

model StepExecution {
  id              String       @id @default(cuid())
  kitExecutionId  String
  kitExecution    KitExecution @relation(fields: [kitExecutionId], references: [id], onDelete: Cascade)

  routeStepId     String
  routeStep       RouteStep    @relation(fields: [routeStepId], references: [id])

  startTime       DateTime
  endTime         DateTime?
  actualDuration  Int?         // seconds
  completed       Boolean      @default(false)

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@map("step_executions")
}

model JobAnalytics {
  id              String     @id @default(cuid())
  jobId           String     @unique
  kittingJob      KittingJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  // Overall job analytics
  totalExpectedTime     Int // seconds
  totalActualTime       Int? // seconds
  efficiencyPercent     Float? // actual vs expected

  // Kit analytics
  avgKitTime            Float? // average actual kit time
  fastestKitTime        Int? // seconds
  slowestKitTime        Int? // seconds

  // Step analytics
  stepAnalytics         Json? // detailed step-by-step analytics

  // Variance tracking
  timeVariance          Float? // standard deviation of kit times
  consistencyScore      Float? // how consistent the worker was

  // Business metrics
  onTimeCompletion      Boolean? // completed by due date
  qualityIssues         Int      @default(0) // count of reported issues

  lastCalculated        DateTime @default(now())
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("job_analytics")
}

enum JobStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  PAUSED
  CANCELLED
}

enum UserRole {
  WORKER
  SUPERVISOR
  ADMIN
}

enum InstructionType {
  NONE
  VIDEO
  IMAGE
  TEXT
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  role         UserRole @default(WORKER)
  workCenterId String?
  workCenter   WorkCenter? @relation(fields: [workCenterId], references: [id])
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  assignedJobs JobAssignment[]

  @@map("users")
}

model WorkCenter {
  id          String @id @default(cuid())
  name        String // "Line A", "Pack Station 2", etc.
  description String?
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  jobProgress JobProgress[]

  @@map("work_centers")
}

model JobAssignment {
  id         String   @id @default(cuid())
  jobId      String
  userId     String
  assignedAt DateTime @default(now())
  assignedBy String   // Admin/Supervisor who made assignment
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  job        KittingJob @relation(fields: [jobId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@unique([jobId, userId]) // Prevent duplicate assignments
  @@map("job_assignments")
}

model Company {
  id                         Int       @id @default(autoincrement())
  companyName                String    @map("company_name")
  ctp                        Int?
  nonPrintContributionPerSqft Decimal?  @map("non_print_contribution_per_sqft") @db.Decimal(10, 6)
  miles                      Int?
  fpp                        Int?
  address1                   String?
  address2                   String?
  address3                   String?
  address4                   String?
  phoneNumber                String?   @map("phone_number")
  customerId                 String?   @map("customer_id")
  shipTo                     String?   @map("ship_to")
  createdAt                  DateTime? @default(now()) @map("created_at")
  updatedAt                  DateTime? @default(now()) @updatedAt @map("updated_at")
  discountRate               Decimal?  @default(0) @db.Decimal(5, 2)
  active                     Boolean?  @default(true)

  // Relations
  kittingJobs                KittingJob[]

  @@map("companies")
}
